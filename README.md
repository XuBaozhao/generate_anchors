# generate_anchors
The generation method of anchor in Faster RCNN

anchor的生成主要是采用了generate_anchors方法：

```
def generate_anchors(base_size=16, ratios=[0.5, 1, 2], scales=2**np.arange(3, 6)):
```

其中传入的参数为：

base_size：16

ratios：[0.5, 1, 2]

scales：[8, 16, 32]

ratio就是不同的长宽比例，scales就是长、宽的扩大尺度



base_size最难理解，其实就是base_size x base_size的大小就是anchor的面积

它的大小虽然是自定义设定的，但是对应于scales能够的最大扩张的尺度应该小于原始输入图像的大小



这里anchor的基本大小设定为16x16



1、设定base_size，这决定了我们的基本anchor有多大

2、设定ratios，这决定了我们的anchor长宽比有多大

3、设定scales，这决定了我们的anchor要放大多少倍



4、例如设定基本anchor为16，首先

```
base_anchor = np.array([1, 1, base_size, base_size]) - 1
```

得到：

```
[ 0  0 15 15 ]
```



5、然后获得中心坐标：

```
w, h, x_ctr, y_ctr = _whctrs(anchor)
```

```
# 将(x1、y1、x2、y2) -> (w、h、mid_x、mid_y)
def _whctrs(anchor):
    """
    返回锚点(窗口)的宽度、高度、x中心和y中心
    anchor :[0 0 15 15]
    """
    # （x2 - x1）宽：15 + 1 = 16
    w = anchor[2] - anchor[0] + 1
    # （y2 - y1）长：15 + 1 = 16
    h = anchor[3] - anchor[1] + 1
    # （x1 + w//2）中心x坐标
    x_ctr = anchor[0] + 0.5 * (w - 1)
    # （y1 + h//2）中心y坐标
    y_ctr = anchor[1] + 0.5 * (h - 1)
    return w, h, x_ctr, y_ctr
```

得到：

```
[16 16 7.5 7.5]
```



6、获得基本anchor的面积：

```
size = w * h
```

得到：

```
anchor面积 16x16=256
```



7、然后获取基本anchor面积 / ratio比例：

```
size_ratios = size / ratios

```

得到：

```
anchor不同比例面积 [512. 256. 128.]

```



8、对面积取根号：

```
ws = np.round(np.sqrt(size_ratios))

```

得到不同比例下的anchor的宽：

```
宽 [23. 16. 11.]

```



9、宽成比例ratio比例：

```
hs = np.round(ws * ratios)

```

得到不同anchor的长：

```
长 [12. 16. 22.]

```



通过以上过程实现了面积为基本面积，长宽比为ratio：

<img src="https://github.com/XuBaozhao/generate_anchors/blob/master/anchor_size.png" />



10、有了长、宽、和中心坐标[7.5 7.5]，得到三种anchor：

```
anchors = _mkanchors(ws, hs, x_ctr, y_ctr)

```

anchor信息为：

```
[[-3.5  2.  18.5 13. ]
 [ 0.   0.  15.  15. ]
 [ 2.5 -3.  12.5 18. ]]

```



11、计算这三组anchor的中心坐标：

```
w, h, x_ctr, y_ctr = _whctrs(anchor)

```

得到：

```
23.0 12.0 7.5 7.5
16.0 16.0 7.5 7.5
11.0 22.0 7.5 7.5

```



12、然后将宽高分别 x scales：

```
ws = w * scales
hs = h * scales

```

```
anchors = np.vstack([_scale_enum(ratio_anchors[i, :], scales)
                     for i in range(ratio_anchors.shape[0])])

```

```
def _scale_enum(anchor, scales):
    """
    为每个标度列出一组锚点
    """
    # 获得宽、高、中心点坐标
    w, h, x_ctr, y_ctr = _whctrs(anchor)

    # 将宽高按不同比例放缩
    ws = w * scales
    hs = h * scales
    print('w * scales = ws:  {} * {} = {}'.format(w, scales, ws))
    print('h * scales = hs:  {} * {} = {}'.format(h, scales, hs))

    # 计算放缩后的框，对应左上角、右下角坐标
    anchors = _mkanchors(ws, hs, x_ctr, y_ctr)
    return anchors

```

得到三组，每组三个，一共九个anchor的长宽大小：

```
    w * scales = ws:  23.0 * [8 16 32] = [184. 368. 736.]
    h * scales = hs:  12.0 * [8 16 32] = [96. 192. 384.]
    
    w * scales = ws:  16.0 * [8 16 32] = [128. 256. 512.]
    h * scales = hs:  16.0 * [8 16 32] = [128. 256. 512.]
    
    w * scales = ws:  11.0 * [8 16 32] = [88. 176. 352.]
    h * scales = hs:  22.0 * [8 16 32] = [176. 352. 704.]

```



13、然后有个9个anchor的长宽大小和中心点坐标[7.5 7.5]

就可以得到9个anchor的基本坐标：

```
       x1    y1    x2    y2
      -83   -39   100    56
      -175   -87   192   104
      -359  -183   376   200
       -55   -55    72    72
      -119  -119   136   136
      -247  -247   264   264
       -35   -79    52    96
       -79  -167    96   184
      -167  -343   184   360

```



接下来进行测试：

1、设定好基本信息：

```
_anchors = torch.from_numpy(generate_anchors(base_size=16,scales=np.array([8, 16, 32]),ratios=np.array([0.5, 1, 2]))).float()

```

得到上13的9个anchor基本坐标

```
       x1    y1    x2    y2
      -83   -39   100    56
      -175   -87   192   104
      -359  -183   376   200
       -55   -55    72    72
      -119  -119   136   136
      -247  -247   264   264
       -35   -79    52    96
       -79  -167    96   184
      -167  -343   184   360

```



2、设定特征图大小：

```
feat_width = 5
feat_height = 5

```



3、设定每隔多少步的像素对应9个anchor：

_feat_stride =  原始图 / 特征图 的大小，这样才能最好的遍布整个原始图

整个图像平均位置处都会存在9个anchor

```
_feat_stride = 2

```



4、得到按_feat_stride步长滑动的网格坐标：

```
shift_x = np.arange(0, feat_width) * _feat_stride
shift_y = np.arange(0, feat_height) * _feat_stride
shift_x, shift_y = np.meshgrid(shift_x, shift_y)
shifts = torch.from_numpy(np.vstack((shift_x.ravel(), shift_y.ravel(),
                                  shift_x.ravel(), shift_y.ravel())).transpose())
shifts = shifts.view(feat_width*feat_height, 1, 4).float()

```

以上面为例：

```
tensor([[[0., 0., 0., 0.]],

        [[2., 0., 2., 0.]],

        [[4., 0., 4., 0.]],

        [[6., 0., 6., 0.]],

        [[8., 0., 8., 0.]],

        [[0., 2., 0., 2.]],

        [[2., 2., 2., 2.]],

        [[4., 2., 4., 2.]],

        [[6., 2., 6., 2.]],

        [[8., 2., 8., 2.]],

        [[0., 4., 0., 4.]],

        [[2., 4., 2., 4.]],

        [[4., 4., 4., 4.]],

        [[6., 4., 6., 4.]],

        [[8., 4., 8., 4.]],

        [[0., 6., 0., 6.]],

        [[2., 6., 2., 6.]],

        [[4., 6., 4., 6.]],

        [[6., 6., 6., 6.]],

        [[8., 6., 8., 6.]],

        [[0., 8., 0., 8.]],

        [[2., 8., 2., 8.]],

        [[4., 8., 4., 8.]],

        [[6., 8., 6., 8.]],

        [[8., 8., 8., 8.]]])

```



5、将每个网格坐标设定9组anchor：

```
anchors = _anchors + shifts
anchors = anchors.view(1, 9*feat_width*feat_height, 4)

```

anchor + 网格坐标：

```
tensor([[[ -84.,  -40.,   99.,   55.],
         [-176.,  -88.,  191.,  103.],
         [-360., -184.,  375.,  199.],
         [ -56.,  -56.,   71.,   71.],
         [-120., -120.,  135.,  135.],
         [-248., -248.,  263.,  263.],
         [ -36.,  -80.,   51.,   95.],
         [ -80., -168.,   95.,  183.],
         [-168., -344.,  183.,  359.],
         [ -82.,  -40.,  101.,   55.],
         [-174.,  -88.,  193.,  103.],
         [-358., -184.,  377.,  199.],
         [ -54.,  -56.,   73.,   71.],
         [-118., -120.,  137.,  135.],
         [-246., -248.,  265.,  263.],
         [ -34.,  -80.,   53.,   95.],
         [ -78., -168.,   97.,  183.],
         [-166., -344.,  185.,  359.],
         [ -80.,  -40.,  103.,   55.],
         [-172.,  -88.,  195.,  103.],
         [-356., -184.,  379.,  199.],
         [ -52.,  -56.,   75.,   71.],
         [-116., -120.,  139.,  135.],
         [-244., -248.,  267.,  263.],
         [ -32.,  -80.,   55.,   95.],
         [ -76., -168.,   99.,  183.],
         [-164., -344.,  187.,  359.],
         [ -78.,  -40.,  105.,   55.],
         [-170.,  -88.,  197.,  103.],
         [-354., -184.,  381.,  199.],
         [ -50.,  -56.,   77.,   71.],
         [-114., -120.,  141.,  135.],
         [-242., -248.,  269.,  263.],
         [ -30.,  -80.,   57.,   95.],
         [ -74., -168.,  101.,  183.],
         [-162., -344.,  189.,  359.],
         [ -76.,  -40.,  107.,   55.],
         [-168.,  -88.,  199.,  103.],
         [-352., -184.,  383.,  199.],
         [ -48.,  -56.,   79.,   71.],
         [-112., -120.,  143.,  135.],
         [-240., -248.,  271.,  263.],
         [ -28.,  -80.,   59.,   95.],
         [ -72., -168.,  103.,  183.],
         [-160., -344.,  191.,  359.],
         [ -84.,  -38.,   99.,   57.],
         [-176.,  -86.,  191.,  105.],
         [-360., -182.,  375.,  201.],
         [ -56.,  -54.,   71.,   73.],
         [-120., -118.,  135.,  137.],
         [-248., -246.,  263.,  265.],
         [ -36.,  -78.,   51.,   97.],
         [ -80., -166.,   95.,  185.],
         [-168., -342.,  183.,  361.],
         [ -82.,  -38.,  101.,   57.],
         [-174.,  -86.,  193.,  105.],
         [-358., -182.,  377.,  201.],
         [ -54.,  -54.,   73.,   73.],
         [-118., -118.,  137.,  137.],
         [-246., -246.,  265.,  265.],
         [ -34.,  -78.,   53.,   97.],
         [ -78., -166.,   97.,  185.],
         [-166., -342.,  185.,  361.],
         [ -80.,  -38.,  103.,   57.],
         [-172.,  -86.,  195.,  105.],
         [-356., -182.,  379.,  201.],
         [ -52.,  -54.,   75.,   73.],
         [-116., -118.,  139.,  137.],
         [-244., -246.,  267.,  265.],
         [ -32.,  -78.,   55.,   97.],
         [ -76., -166.,   99.,  185.],
         [-164., -342.,  187.,  361.],
         [ -78.,  -38.,  105.,   57.],
         [-170.,  -86.,  197.,  105.],
         [-354., -182.,  381.,  201.],
         [ -50.,  -54.,   77.,   73.],
         [-114., -118.,  141.,  137.],
         [-242., -246.,  269.,  265.],
         [ -30.,  -78.,   57.,   97.],
         [ -74., -166.,  101.,  185.],
         [-162., -342.,  189.,  361.],
         [ -76.,  -38.,  107.,   57.],
         [-168.,  -86.,  199.,  105.],
         [-352., -182.,  383.,  201.],
         [ -48.,  -54.,   79.,   73.],
         [-112., -118.,  143.,  137.],
         [-240., -246.,  271.,  265.],
         [ -28.,  -78.,   59.,   97.],
         [ -72., -166.,  103.,  185.],
         [-160., -342.,  191.,  361.],
         [ -84.,  -36.,   99.,   59.],
         [-176.,  -84.,  191.,  107.],
         [-360., -180.,  375.,  203.],
         [ -56.,  -52.,   71.,   75.],
         [-120., -116.,  135.,  139.],
         [-248., -244.,  263.,  267.],
         [ -36.,  -76.,   51.,   99.],
         [ -80., -164.,   95.,  187.],
         [-168., -340.,  183.,  363.],
         [ -82.,  -36.,  101.,   59.],
         [-174.,  -84.,  193.,  107.],
         [-358., -180.,  377.,  203.],
         [ -54.,  -52.,   73.,   75.],
         [-118., -116.,  137.,  139.],
         [-246., -244.,  265.,  267.],
         [ -34.,  -76.,   53.,   99.],
         [ -78., -164.,   97.,  187.],
         [-166., -340.,  185.,  363.],
         [ -80.,  -36.,  103.,   59.],
         [-172.,  -84.,  195.,  107.],
         [-356., -180.,  379.,  203.],
         [ -52.,  -52.,   75.,   75.],
         [-116., -116.,  139.,  139.],
         [-244., -244.,  267.,  267.],
         [ -32.,  -76.,   55.,   99.],
         [ -76., -164.,   99.,  187.],
         [-164., -340.,  187.,  363.],
         [ -78.,  -36.,  105.,   59.],
         [-170.,  -84.,  197.,  107.],
         [-354., -180.,  381.,  203.],
         [ -50.,  -52.,   77.,   75.],
         [-114., -116.,  141.,  139.],
         [-242., -244.,  269.,  267.],
         [ -30.,  -76.,   57.,   99.],
         [ -74., -164.,  101.,  187.],
         [-162., -340.,  189.,  363.],
         [ -76.,  -36.,  107.,   59.],
         [-168.,  -84.,  199.,  107.],
         [-352., -180.,  383.,  203.],
         [ -48.,  -52.,   79.,   75.],
         [-112., -116.,  143.,  139.],
         [-240., -244.,  271.,  267.],
         [ -28.,  -76.,   59.,   99.],
         [ -72., -164.,  103.,  187.],
         [-160., -340.,  191.,  363.],
         [ -84.,  -34.,   99.,   61.],
         [-176.,  -82.,  191.,  109.],
         [-360., -178.,  375.,  205.],
         [ -56.,  -50.,   71.,   77.],
         [-120., -114.,  135.,  141.],
         [-248., -242.,  263.,  269.],
         [ -36.,  -74.,   51.,  101.],
         [ -80., -162.,   95.,  189.],
         [-168., -338.,  183.,  365.],
         [ -82.,  -34.,  101.,   61.],
         [-174.,  -82.,  193.,  109.],
         [-358., -178.,  377.,  205.],
         [ -54.,  -50.,   73.,   77.],
         [-118., -114.,  137.,  141.],
         [-246., -242.,  265.,  269.],
         [ -34.,  -74.,   53.,  101.],
         [ -78., -162.,   97.,  189.],
         [-166., -338.,  185.,  365.],
         [ -80.,  -34.,  103.,   61.],
         [-172.,  -82.,  195.,  109.],
         [-356., -178.,  379.,  205.],
         [ -52.,  -50.,   75.,   77.],
         [-116., -114.,  139.,  141.],
         [-244., -242.,  267.,  269.],
         [ -32.,  -74.,   55.,  101.],
         [ -76., -162.,   99.,  189.],
         [-164., -338.,  187.,  365.],
         [ -78.,  -34.,  105.,   61.],
         [-170.,  -82.,  197.,  109.],
         [-354., -178.,  381.,  205.],
         [ -50.,  -50.,   77.,   77.],
         [-114., -114.,  141.,  141.],
         [-242., -242.,  269.,  269.],
         [ -30.,  -74.,   57.,  101.],
         [ -74., -162.,  101.,  189.],
         [-162., -338.,  189.,  365.],
         [ -76.,  -34.,  107.,   61.],
         [-168.,  -82.,  199.,  109.],
         [-352., -178.,  383.,  205.],
         [ -48.,  -50.,   79.,   77.],
         [-112., -114.,  143.,  141.],
         [-240., -242.,  271.,  269.],
         [ -28.,  -74.,   59.,  101.],
         [ -72., -162.,  103.,  189.],
         [-160., -338.,  191.,  365.],
         [ -84.,  -32.,   99.,   63.],
         [-176.,  -80.,  191.,  111.],
         [-360., -176.,  375.,  207.],
         [ -56.,  -48.,   71.,   79.],
         [-120., -112.,  135.,  143.],
         [-248., -240.,  263.,  271.],
         [ -36.,  -72.,   51.,  103.],
         [ -80., -160.,   95.,  191.],
         [-168., -336.,  183.,  367.],
         [ -82.,  -32.,  101.,   63.],
         [-174.,  -80.,  193.,  111.],
         [-358., -176.,  377.,  207.],
         [ -54.,  -48.,   73.,   79.],
         [-118., -112.,  137.,  143.],
         [-246., -240.,  265.,  271.],
         [ -34.,  -72.,   53.,  103.],
         [ -78., -160.,   97.,  191.],
         [-166., -336.,  185.,  367.],
         [ -80.,  -32.,  103.,   63.],
         [-172.,  -80.,  195.,  111.],
         [-356., -176.,  379.,  207.],
         [ -52.,  -48.,   75.,   79.],
         [-116., -112.,  139.,  143.],
         [-244., -240.,  267.,  271.],
         [ -32.,  -72.,   55.,  103.],
         [ -76., -160.,   99.,  191.],
         [-164., -336.,  187.,  367.],
         [ -78.,  -32.,  105.,   63.],
         [-170.,  -80.,  197.,  111.],
         [-354., -176.,  381.,  207.],
         [ -50.,  -48.,   77.,   79.],
         [-114., -112.,  141.,  143.],
         [-242., -240.,  269.,  271.],
         [ -30.,  -72.,   57.,  103.],
         [ -74., -160.,  101.,  191.],
         [-162., -336.,  189.,  367.],
         [ -76.,  -32.,  107.,   63.],
         [-168.,  -80.,  199.,  111.],
         [-352., -176.,  383.,  207.],
         [ -48.,  -48.,   79.,   79.],
         [-112., -112.,  143.,  143.],
         [-240., -240.,  271.,  271.],
         [ -28.,  -72.,   59.,  103.],
         [ -72., -160.,  103.,  191.],
         [-160., -336.,  191.,  367.]]])

```



我们测试一下：

测试图像为：

![lebron](/Users/qishi/faster-rcnn.pytorch/lebron.jpg)

图像大小为：(792, 1024, 3)

然后：

```
_anchors = torch.from_numpy(base_size=16， generate_anchors(scales=np.array([4, 8, 16]), ratios=np.array([0.5, 1, 2]))).float()

```

最大长16 x 16 x 根2 = 256 x 1.1415926 = 292

最大宽16 x 16 x 根2 = 292

我们看到对于中间的大人来讲，大约高位600了，框有点小，我们设置大一点：

```
_anchors = torch.from_numpy(generate_anchors(scales=np.array([8, 16, 32]),
            ratios=np.array([0.5, 1, 2]))).float()

```

16  x 32 x 根2 = 600差不多

我希望框不要那么密集，不然就看不出来框了，所以我设定_feat_stride = 100，也就是每隔100个像素对应9个anchor

那么我们的特征图设定多大呢？

800 / 100 = 8

1000 / 100 = 10

```
feat_width = 10
feat_height = 8
_feat_stride = 100

```

运行观察一下图像：

![2](/Users/qishi/faster-rcnn.pytorch/2.jpg)

差不多全覆盖了，但是看不出框的大小

我们把_feat_stride设定大一点，看看anchor大小：

_feat_stride = 400

特征图大小：800 / 400 = 2  1000 / 400 = 3

看一下结果：

![](/Users/qishi/Library/Application Support/typora-user-images/image-20200324183452766.png)

这样就能清晰的看到9个anchor了
